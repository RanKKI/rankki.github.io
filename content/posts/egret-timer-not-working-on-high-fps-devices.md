---
title: "白鹭 Egret 引擎在高帧率设备上 Timer 不准确的解决"
date: 2020-12-05T21:14:46+08:00
tags:
 - Egret
 - WeChat
categories:
 - 技术
---

目前实习在的项目组的产品，经常有玩家反馈某个地方倒计时会变快，内部也有小伙伴发现了这个问题，在 iPad Pro 上更是达到了 2 倍速， 但因为受影响的用户很少很少，一直没修。上周，因为日程上不是很忙，便找了一天去修复这个 bug。

经过测试， web 端不会出现这个情况，但微信小游戏上会有速度变快。

首先是在白鹭的开发者论坛上，找了个一篇帖子[基于系统时间的计时器DateTimer(不受FPS影响)](https://bbs.egret.com/thread-27732-1-1.html)看了下代码， 没有问题， 根据时间戳计算差值，然后再 dispatch 事件。 便直接放进项目里尝试，确实解决了倒计时变快的问题，但这很怪异，白鹭不应该会有这么奇怪的 bug, 然后我的 Leader 拉了个群， 其中包括引擎组和隔壁项目组的大佬们，讨论这个问题。

其中一位指出，白鹭也是这么做的，通过查看源码，确实是的， 但在注释里标记了，最高支持到 60 FPS, 而 iPad Pro 是 120 FPS 的设备，因此导致了 1000ms Delay 的 Timer，会在 1 秒内触发两次，而我们的倒计时并没有计算时间的差值，而是直接 `timer--` 所以导致速度异常。

而 Web 端没有问题是因为项目有限制 FPS 到 60， 但这个限制对微信小游戏不好使，解决方法是手动使用 `wx.setPreferredFramesPerSecond(fps)`, 限制 FPS 到 60。