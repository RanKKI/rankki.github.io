<!doctype html><html lang=zh-cn><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>使用 Certbot 对内网域名签名 | RanKKI's Blog</title>
<link rel=canonical href=https://rankki.xyz/posts/certbot-sign-internal-domain/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://rankki.xyz/posts/certbot-sign-internal-domain/"><meta property="og:site_name" content="RanKKI's Blog"><meta property="og:title" content="使用 Certbot 对内网域名签名"><meta property="og:description" content="前情提要 有一个 All-In-boomOne 的服务器，然后为了方便管理，不用记 IP 地址。搭建了一台内网 DNS 服务，并使用自己的某三级域名 internal.example.org 作为内网域名使用。
虽然说内网服务，上不上 HTTPS 没差，但在 iOS Safari 上会有不安全的提醒，以及没有那把小锁🔒，看着不舒服。
Certbot 在签名的时候，会查 DNS 记录，但内网域名只在内网使用，怎么可能会有公网的 DNS 记录呢。
以及，我的 nginx 是放在 Docker 里跑的，相对于直接在宿主机上还是有点区别的
解决方案 在某 medium 文章中1，使用了 Certbot 的 Docker 镜像，并且将该容器的一些目录和 nginx 容器目录做了共享。
1 2 3 4 5 6 7 8 9 10 11 12 13 services: web: container_name: nginx image: docker.io/nginx volumes: - ${PWD}/conf.d:/etc/nginx/conf.d - ${PWD}/certbot/conf:/etc/letsencrypt - ${PWD}/certbot/www:/var/www/certbot certbot: image: docker.io/certbot/certbot volumes: - ${PWD}/certbot/conf:/etc/letsencrypt - ${PWD}/certbot/www:/var/www/certbot 配置 Nginx 然后在 nginx 的 *."><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-05T22:48:16+11:00"><meta property="article:modified_time" content="2023-03-05T23:16:31+11:00"><meta property="article:tag" content="Certbot"><meta property="article:tag" content="Domain"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 Certbot 对内网域名签名"><meta name=twitter:description content="前情提要 有一个 All-In-boomOne 的服务器，然后为了方便管理，不用记 IP 地址。搭建了一台内网 DNS 服务，并使用自己的某三级域名 internal.example.org 作为内网域名使用。
虽然说内网服务，上不上 HTTPS 没差，但在 iOS Safari 上会有不安全的提醒，以及没有那把小锁🔒，看着不舒服。
Certbot 在签名的时候，会查 DNS 记录，但内网域名只在内网使用，怎么可能会有公网的 DNS 记录呢。
以及，我的 nginx 是放在 Docker 里跑的，相对于直接在宿主机上还是有点区别的
解决方案 在某 medium 文章中1，使用了 Certbot 的 Docker 镜像，并且将该容器的一些目录和 nginx 容器目录做了共享。
1 2 3 4 5 6 7 8 9 10 11 12 13 services: web: container_name: nginx image: docker.io/nginx volumes: - ${PWD}/conf.d:/etc/nginx/conf.d - ${PWD}/certbot/conf:/etc/letsencrypt - ${PWD}/certbot/www:/var/www/certbot certbot: image: docker.io/certbot/certbot volumes: - ${PWD}/certbot/conf:/etc/letsencrypt - ${PWD}/certbot/www:/var/www/certbot 配置 Nginx 然后在 nginx 的 *."><link rel=stylesheet href=https://rankki.xyz/css/styles.703587cbc83e3d6c4abb083f3126cd73c5c67af0782c70bbc9e4643c1d171ec879a51fed1fd12cf82e0469fc4c2454f83d63696957494d2268aa2cc691a4ef06.css><link rel=stylesheet href=https://rankki.xyz/css/syntax.css><link rel=stylesheet href=https://rankki.xyz/css/loading.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://rankki.xyz/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://rankki.xyz/><div id=title><h1>RanKKI's Blog</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/>Home</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></div></header><div id=header-post><span id=menu><div id=toc><nav id=TableOfContents><ul><li><a href=#配置-nginx>配置 Nginx</a></li><li><a href=#下载配置文件>下载配置文件</a></li><li><a href=#手动签名2>手动签名</a></li><li><a href=#后续>后续</a></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">使用 Certbot 对内网域名签名</h1><div class=meta><div class=postdate><time datetime="2023-03-05 22:48:16 +1100 +1100" itemprop=datePublished>2023-03-05</time></div><div class=article-read-time><i class="far fa-clock"></i>
3 minute read</div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/certbot rel=tag>Certbot</a>
,
<a class=tag-link href=/tags/domain rel=tag>Domain</a></div></div></header><div class=content itemprop=articleBody><h1 id=前情提要>前情提要</h1><p>有一个 All-In-<del>boom</del>One 的服务器，然后为了方便管理，不用记 IP 地址。搭建了一台内网 DNS 服务，并使用自己的某三级域名 internal.example.org 作为内网域名使用。</p><p>虽然说内网服务，上不上 HTTPS 没差，但在 iOS Safari 上会有不安全的提醒，以及没有那把小锁🔒，看着不舒服。</p><p>Certbot 在签名的时候，会查 DNS 记录，但内网域名只在内网使用，怎么可能会有公网的 DNS 记录呢。</p><p>以及，我的 nginx 是放在 Docker 里跑的，相对于直接在宿主机上还是有点区别的</p><h1 id=解决方案>解决方案</h1><p>在某 medium 文章中<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>，使用了 Certbot 的 Docker 镜像，并且将该容器的一些目录和 nginx 容器目录做了共享。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl>services:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  web:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    container_name: nginx<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    image: docker.io/nginx<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    volumes:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=si>${</span><span class=nv>PWD</span><span class=si>}</span>/conf.d:/etc/nginx/conf.d<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=si>${</span><span class=nv>PWD</span><span class=si>}</span>/certbot/conf:/etc/letsencrypt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=si>${</span><span class=nv>PWD</span><span class=si>}</span>/certbot/www:/var/www/certbot<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  certbot:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    image: docker.io/certbot/certbot<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    volumes:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=si>${</span><span class=nv>PWD</span><span class=si>}</span>/certbot/conf:/etc/letsencrypt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=si>${</span><span class=nv>PWD</span><span class=si>}</span>/certbot/www:/var/www/certbot<span class=err>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=配置-nginx>配置 Nginx</h2><p>然后在 nginx 的 <code>*.conf</code> 文件中增加</p><pre tabindex=0><code>server {
    listen 80;

    location / {
        return 301 https://$host$request_uri;
    }

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
}

server {
    listen 443;

    ssl_certificate /etc/letsencrypt/live/&lt;YOUR-DOMAIN&gt;/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/&lt;YOUR-DOMAIN&gt;/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    ...
}
</code></pre><h2 id=下载配置文件>下载配置文件</h2><p>然后下载下 TLS 的一些配置</p><pre tabindex=0><code>curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf &gt; &#34;${PWD}/certbot/conf/options-ssl-nginx.conf&#34;
curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot/certbot/ssl-dhparams.pem &gt; &#34;${PWD}/certbot/conf/ssl-dhparams.pem&#34;
</code></pre><h2 id=手动签名2>手动签名<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></h2><p>首先你肯定有二级域名（或者叫一级域名，如果不考虑 <code>.com</code> 这一层）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>podman-compose run --rm --entrypoint <span class=s2>&#34;\
</span></span></span><span class=line><span class=cl><span class=s2>certbot certonly --manual --preferred-challenges dns \
</span></span></span><span class=line><span class=cl><span class=s2>-d &lt;your-internal-domain&gt;&#34;</span> certbot
</span></span></code></pre></td></tr></table></div></div><p>这里会提示，让你在域名里加一个 TXT 记录，Key 是 <code>_acme-challenge.&lt;prefix></code>，等 TXT 记录生效后，回车继续，签名信息就被写入到了 <code>${PWD}/certbot/conf/live/&lt;domain></code></p><p>这时候再重启 nginx 服务，就解决所有问题了。</p><h2 id=后续>后续</h2><p>这么做的一个坏处就是，没法自动更新证书，需要手动跑命令更新。</p><p>考虑到证书有效期 3 个月， 到还能接受。</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://pentacent.medium.com/nginx-and-lets-encrypt-with-docker-in-less-than-5-minutes-b4b8a60d3a71>Nginx and Let’s Encrypt with Docker in Less Than 5 Minutes</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://www.cnblogs.com/k4nz/p/14523264.html>「Certbot」- 在内网中申请证书的方法 @20210312</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article><footer id=footer><div class=footer-left>Copyright &copy; 2024 Hugh(Hui) Liu</div><script src=https://code.iconify.design/2/2.0.4/iconify.min.js></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "7f02cdd7074d4e1f8125c11651f47699"}'></script></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>