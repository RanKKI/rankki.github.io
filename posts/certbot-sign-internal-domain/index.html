<!doctype html><html lang=zh-cn><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>ä½¿ç”¨ Certbot å¯¹å†…ç½‘åŸŸåç­¾å | RanKKI's Blog</title>
<link rel=canonical href=https://rankki.xyz/posts/certbot-sign-internal-domain/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://rankki.xyz/posts/certbot-sign-internal-domain/"><meta property="og:site_name" content="RanKKI's Blog"><meta property="og:title" content="ä½¿ç”¨ Certbot å¯¹å†…ç½‘åŸŸåç­¾å"><meta property="og:description" content="å‰æƒ…æè¦ æœ‰ä¸€ä¸ª All-In-boomOne çš„æœåŠ¡å™¨ï¼Œç„¶åä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œä¸ç”¨è®° IP åœ°å€ã€‚æ­å»ºäº†ä¸€å°å†…ç½‘ DNS æœåŠ¡ï¼Œå¹¶ä½¿ç”¨è‡ªå·±çš„æŸä¸‰çº§åŸŸå internal.example.org ä½œä¸ºå†…ç½‘åŸŸåä½¿ç”¨ã€‚
è™½ç„¶è¯´å†…ç½‘æœåŠ¡ï¼Œä¸Šä¸ä¸Š HTTPS æ²¡å·®ï¼Œä½†åœ¨ iOS Safari ä¸Šä¼šæœ‰ä¸å®‰å…¨çš„æé†’ï¼Œä»¥åŠæ²¡æœ‰é‚£æŠŠå°é”ğŸ”’ï¼Œçœ‹ç€ä¸èˆ’æœã€‚
Certbot åœ¨ç­¾åçš„æ—¶å€™ï¼Œä¼šæŸ¥ DNS è®°å½•ï¼Œä½†å†…ç½‘åŸŸååªåœ¨å†…ç½‘ä½¿ç”¨ï¼Œæ€ä¹ˆå¯èƒ½ä¼šæœ‰å…¬ç½‘çš„ DNS è®°å½•å‘¢ã€‚
ä»¥åŠï¼Œæˆ‘çš„ nginx æ˜¯æ”¾åœ¨ Docker é‡Œè·‘çš„ï¼Œç›¸å¯¹äºç›´æ¥åœ¨å®¿ä¸»æœºä¸Šè¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«çš„
è§£å†³æ–¹æ¡ˆ åœ¨æŸ medium æ–‡ç« ä¸­1ï¼Œä½¿ç”¨äº† Certbot çš„ Docker é•œåƒï¼Œå¹¶ä¸”å°†è¯¥å®¹å™¨çš„ä¸€äº›ç›®å½•å’Œ nginx å®¹å™¨ç›®å½•åšäº†å…±äº«ã€‚
1 2 3 4 5 6 7 8 9 10 11 12 13 services: web: container_name: nginx image: docker.io/nginx volumes: - ${PWD}/conf.d:/etc/nginx/conf.d - ${PWD}/certbot/conf:/etc/letsencrypt - ${PWD}/certbot/www:/var/www/certbot certbot: image: docker.io/certbot/certbot volumes: - ${PWD}/certbot/conf:/etc/letsencrypt - ${PWD}/certbot/www:/var/www/certbot é…ç½® Nginx ç„¶ååœ¨ nginx çš„ *."><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-05T22:48:16+11:00"><meta property="article:modified_time" content="2023-03-05T23:16:31+11:00"><meta property="article:tag" content="Certbot"><meta property="article:tag" content="Domain"><meta name=twitter:card content="summary"><meta name=twitter:title content="ä½¿ç”¨ Certbot å¯¹å†…ç½‘åŸŸåç­¾å"><meta name=twitter:description content="å‰æƒ…æè¦ æœ‰ä¸€ä¸ª All-In-boomOne çš„æœåŠ¡å™¨ï¼Œç„¶åä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œä¸ç”¨è®° IP åœ°å€ã€‚æ­å»ºäº†ä¸€å°å†…ç½‘ DNS æœåŠ¡ï¼Œå¹¶ä½¿ç”¨è‡ªå·±çš„æŸä¸‰çº§åŸŸå internal.example.org ä½œä¸ºå†…ç½‘åŸŸåä½¿ç”¨ã€‚
è™½ç„¶è¯´å†…ç½‘æœåŠ¡ï¼Œä¸Šä¸ä¸Š HTTPS æ²¡å·®ï¼Œä½†åœ¨ iOS Safari ä¸Šä¼šæœ‰ä¸å®‰å…¨çš„æé†’ï¼Œä»¥åŠæ²¡æœ‰é‚£æŠŠå°é”ğŸ”’ï¼Œçœ‹ç€ä¸èˆ’æœã€‚
Certbot åœ¨ç­¾åçš„æ—¶å€™ï¼Œä¼šæŸ¥ DNS è®°å½•ï¼Œä½†å†…ç½‘åŸŸååªåœ¨å†…ç½‘ä½¿ç”¨ï¼Œæ€ä¹ˆå¯èƒ½ä¼šæœ‰å…¬ç½‘çš„ DNS è®°å½•å‘¢ã€‚
ä»¥åŠï¼Œæˆ‘çš„ nginx æ˜¯æ”¾åœ¨ Docker é‡Œè·‘çš„ï¼Œç›¸å¯¹äºç›´æ¥åœ¨å®¿ä¸»æœºä¸Šè¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«çš„
è§£å†³æ–¹æ¡ˆ åœ¨æŸ medium æ–‡ç« ä¸­1ï¼Œä½¿ç”¨äº† Certbot çš„ Docker é•œåƒï¼Œå¹¶ä¸”å°†è¯¥å®¹å™¨çš„ä¸€äº›ç›®å½•å’Œ nginx å®¹å™¨ç›®å½•åšäº†å…±äº«ã€‚
1 2 3 4 5 6 7 8 9 10 11 12 13 services: web: container_name: nginx image: docker.io/nginx volumes: - ${PWD}/conf.d:/etc/nginx/conf.d - ${PWD}/certbot/conf:/etc/letsencrypt - ${PWD}/certbot/www:/var/www/certbot certbot: image: docker.io/certbot/certbot volumes: - ${PWD}/certbot/conf:/etc/letsencrypt - ${PWD}/certbot/www:/var/www/certbot é…ç½® Nginx ç„¶ååœ¨ nginx çš„ *."><link rel=stylesheet href=https://rankki.xyz/css/styles.703587cbc83e3d6c4abb083f3126cd73c5c67af0782c70bbc9e4643c1d171ec879a51fed1fd12cf82e0469fc4c2454f83d63696957494d2268aa2cc691a4ef06.css><link rel=stylesheet href=https://rankki.xyz/css/syntax.css><link rel=stylesheet href=https://rankki.xyz/css/loading.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://rankki.xyz/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://rankki.xyz/><div id=title><h1>RanKKI's Blog</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/>Home</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></div></header><div id=header-post><span id=menu><div id=toc><nav id=TableOfContents><ul><li><a href=#é…ç½®-nginx>é…ç½® Nginx</a></li><li><a href=#ä¸‹è½½é…ç½®æ–‡ä»¶>ä¸‹è½½é…ç½®æ–‡ä»¶</a></li><li><a href=#æ‰‹åŠ¨ç­¾å2>æ‰‹åŠ¨ç­¾å</a></li><li><a href=#åç»­>åç»­</a></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">ä½¿ç”¨ Certbot å¯¹å†…ç½‘åŸŸåç­¾å</h1><div class=meta><div class=postdate><time datetime="2023-03-05 22:48:16 +1100 +1100" itemprop=datePublished>2023-03-05</time></div><div class=article-read-time><i class="far fa-clock"></i>
3 minute read</div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/certbot rel=tag>Certbot</a>
,
<a class=tag-link href=/tags/domain rel=tag>Domain</a></div></div></header><div class=content itemprop=articleBody><h1 id=å‰æƒ…æè¦>å‰æƒ…æè¦</h1><p>æœ‰ä¸€ä¸ª All-In-<del>boom</del>One çš„æœåŠ¡å™¨ï¼Œç„¶åä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œä¸ç”¨è®° IP åœ°å€ã€‚æ­å»ºäº†ä¸€å°å†…ç½‘ DNS æœåŠ¡ï¼Œå¹¶ä½¿ç”¨è‡ªå·±çš„æŸä¸‰çº§åŸŸå internal.example.org ä½œä¸ºå†…ç½‘åŸŸåä½¿ç”¨ã€‚</p><p>è™½ç„¶è¯´å†…ç½‘æœåŠ¡ï¼Œä¸Šä¸ä¸Š HTTPS æ²¡å·®ï¼Œä½†åœ¨ iOS Safari ä¸Šä¼šæœ‰ä¸å®‰å…¨çš„æé†’ï¼Œä»¥åŠæ²¡æœ‰é‚£æŠŠå°é”ğŸ”’ï¼Œçœ‹ç€ä¸èˆ’æœã€‚</p><p>Certbot åœ¨ç­¾åçš„æ—¶å€™ï¼Œä¼šæŸ¥ DNS è®°å½•ï¼Œä½†å†…ç½‘åŸŸååªåœ¨å†…ç½‘ä½¿ç”¨ï¼Œæ€ä¹ˆå¯èƒ½ä¼šæœ‰å…¬ç½‘çš„ DNS è®°å½•å‘¢ã€‚</p><p>ä»¥åŠï¼Œæˆ‘çš„ nginx æ˜¯æ”¾åœ¨ Docker é‡Œè·‘çš„ï¼Œç›¸å¯¹äºç›´æ¥åœ¨å®¿ä¸»æœºä¸Šè¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«çš„</p><h1 id=è§£å†³æ–¹æ¡ˆ>è§£å†³æ–¹æ¡ˆ</h1><p>åœ¨æŸ medium æ–‡ç« ä¸­<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>ï¼Œä½¿ç”¨äº† Certbot çš„ Docker é•œåƒï¼Œå¹¶ä¸”å°†è¯¥å®¹å™¨çš„ä¸€äº›ç›®å½•å’Œ nginx å®¹å™¨ç›®å½•åšäº†å…±äº«ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl>services:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  web:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    container_name: nginx<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    image: docker.io/nginx<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    volumes:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=si>${</span><span class=nv>PWD</span><span class=si>}</span>/conf.d:/etc/nginx/conf.d<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=si>${</span><span class=nv>PWD</span><span class=si>}</span>/certbot/conf:/etc/letsencrypt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=si>${</span><span class=nv>PWD</span><span class=si>}</span>/certbot/www:/var/www/certbot<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  certbot:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    image: docker.io/certbot/certbot<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    volumes:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=si>${</span><span class=nv>PWD</span><span class=si>}</span>/certbot/conf:/etc/letsencrypt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=si>${</span><span class=nv>PWD</span><span class=si>}</span>/certbot/www:/var/www/certbot<span class=err>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=é…ç½®-nginx>é…ç½® Nginx</h2><p>ç„¶ååœ¨ nginx çš„ <code>*.conf</code> æ–‡ä»¶ä¸­å¢åŠ </p><pre tabindex=0><code>server {
    listen 80;

    location / {
        return 301 https://$host$request_uri;
    }

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
}

server {
    listen 443;

    ssl_certificate /etc/letsencrypt/live/&lt;YOUR-DOMAIN&gt;/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/&lt;YOUR-DOMAIN&gt;/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    ...
}
</code></pre><h2 id=ä¸‹è½½é…ç½®æ–‡ä»¶>ä¸‹è½½é…ç½®æ–‡ä»¶</h2><p>ç„¶åä¸‹è½½ä¸‹ TLS çš„ä¸€äº›é…ç½®</p><pre tabindex=0><code>curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf &gt; &#34;${PWD}/certbot/conf/options-ssl-nginx.conf&#34;
curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot/certbot/ssl-dhparams.pem &gt; &#34;${PWD}/certbot/conf/ssl-dhparams.pem&#34;
</code></pre><h2 id=æ‰‹åŠ¨ç­¾å2>æ‰‹åŠ¨ç­¾å<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></h2><p>é¦–å…ˆä½ è‚¯å®šæœ‰äºŒçº§åŸŸåï¼ˆæˆ–è€…å«ä¸€çº§åŸŸåï¼Œå¦‚æœä¸è€ƒè™‘ <code>.com</code> è¿™ä¸€å±‚ï¼‰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>podman-compose run --rm --entrypoint <span class=s2>&#34;\
</span></span></span><span class=line><span class=cl><span class=s2>certbot certonly --manual --preferred-challenges dns \
</span></span></span><span class=line><span class=cl><span class=s2>-d &lt;your-internal-domain&gt;&#34;</span> certbot
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œä¼šæç¤ºï¼Œè®©ä½ åœ¨åŸŸåé‡ŒåŠ ä¸€ä¸ª TXT è®°å½•ï¼ŒKey æ˜¯ <code>_acme-challenge.&lt;prefix></code>ï¼Œç­‰ TXT è®°å½•ç”Ÿæ•ˆåï¼Œå›è½¦ç»§ç»­ï¼Œç­¾åä¿¡æ¯å°±è¢«å†™å…¥åˆ°äº† <code>${PWD}/certbot/conf/live/&lt;domain></code></p><p>è¿™æ—¶å€™å†é‡å¯ nginx æœåŠ¡ï¼Œå°±è§£å†³æ‰€æœ‰é—®é¢˜äº†ã€‚</p><h2 id=åç»­>åç»­</h2><p>è¿™ä¹ˆåšçš„ä¸€ä¸ªåå¤„å°±æ˜¯ï¼Œæ²¡æ³•è‡ªåŠ¨æ›´æ–°è¯ä¹¦ï¼Œéœ€è¦æ‰‹åŠ¨è·‘å‘½ä»¤æ›´æ–°ã€‚</p><p>è€ƒè™‘åˆ°è¯ä¹¦æœ‰æ•ˆæœŸ 3 ä¸ªæœˆï¼Œ åˆ°è¿˜èƒ½æ¥å—ã€‚</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://pentacent.medium.com/nginx-and-lets-encrypt-with-docker-in-less-than-5-minutes-b4b8a60d3a71>Nginx and Letâ€™s Encrypt with Docker in Less Than 5 Minutes</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://www.cnblogs.com/k4nz/p/14523264.html>ã€ŒCertbotã€- åœ¨å†…ç½‘ä¸­ç”³è¯·è¯ä¹¦çš„æ–¹æ³• @20210312</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article><footer id=footer><div class=footer-left>Copyright &copy; 2024 Hugh(Hui) Liu</div><script src=https://code.iconify.design/2/2.0.4/iconify.min.js></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "7f02cdd7074d4e1f8125c11651f47699"}'></script></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>