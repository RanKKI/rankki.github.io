<!doctype html><html lang=zh-cn><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Cocos Creator 3.3 版本写 2D 游戏，点击事件无反应 | RanKKI's Blog</title>
<link rel=canonical href=https://rankki.xyz/posts/cocos-creator-click-event-does-not-working/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://rankki.xyz/posts/cocos-creator-click-event-does-not-working/"><meta property="og:site_name" content="RanKKI's Blog"><meta property="og:title" content="Cocos Creator 3.3 版本写 2D 游戏，点击事件无反应"><meta property="og:description" content="周末闲来无事，学习下 Cocos Creator 3.3 (以下简称 CC)，之前接触的版本是 2.X。3.X 最大的改变是合并了 CC 3D 这个项目，官方的介绍是
Cocos Creator 3.0 集成了原有 2D 和 3D 两套产品的所有功能，带来了诸多重大更新，将做为 Creator 之后的主力版本。同时 v3.0 还延续了 Cocos 在 2D 品类上轻量高效的优势，并且为 3D 重度游戏提供高效的开发体验。 来源
相较于 2D 游戏的 x & y 轴， 3D 游戏多了 z 轴的概念，毕竟是 3D 空间
现象 在写游戏中，经常需要给某个节点增加一个缓动的动画，基本上是这么写
1 2 3 4 tween(this.node) .to(5 / 24, { scale: new math.Vec3(1.1, 1.1) }) .to(5 / 24, { scale: new math.Vec3(1.0, 1.0) }) .start() 这就是一个很普通的放大再缩小的动画，但在这个动画被出发之后，我发现这个节点的点击事件不好使了。 本来以为是哪个把这个节点上 Button 组件设置为禁止点击了。但通过删除相关代码，延迟打印interactable，结果都是证明了，这个组件没有问题。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-20T11:30:38+08:00"><meta property="article:modified_time" content="2021-09-20T20:24:03+08:00"><meta property="article:tag" content="Cocos Creator"><meta name=twitter:card content="summary"><meta name=twitter:title content="Cocos Creator 3.3 版本写 2D 游戏，点击事件无反应"><meta name=twitter:description content="周末闲来无事，学习下 Cocos Creator 3.3 (以下简称 CC)，之前接触的版本是 2.X。3.X 最大的改变是合并了 CC 3D 这个项目，官方的介绍是
Cocos Creator 3.0 集成了原有 2D 和 3D 两套产品的所有功能，带来了诸多重大更新，将做为 Creator 之后的主力版本。同时 v3.0 还延续了 Cocos 在 2D 品类上轻量高效的优势，并且为 3D 重度游戏提供高效的开发体验。 来源
相较于 2D 游戏的 x & y 轴， 3D 游戏多了 z 轴的概念，毕竟是 3D 空间
现象 在写游戏中，经常需要给某个节点增加一个缓动的动画，基本上是这么写
1 2 3 4 tween(this.node) .to(5 / 24, { scale: new math.Vec3(1.1, 1.1) }) .to(5 / 24, { scale: new math.Vec3(1.0, 1.0) }) .start() 这就是一个很普通的放大再缩小的动画，但在这个动画被出发之后，我发现这个节点的点击事件不好使了。 本来以为是哪个把这个节点上 Button 组件设置为禁止点击了。但通过删除相关代码，延迟打印interactable，结果都是证明了，这个组件没有问题。"><link rel=stylesheet href=https://rankki.xyz/css/styles.703587cbc83e3d6c4abb083f3126cd73c5c67af0782c70bbc9e4643c1d171ec879a51fed1fd12cf82e0469fc4c2454f83d63696957494d2268aa2cc691a4ef06.css><link rel=stylesheet href=https://rankki.xyz/css/syntax.css><link rel=stylesheet href=https://rankki.xyz/css/loading.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://rankki.xyz/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://rankki.xyz/><div id=title><h1>RanKKI's Blog</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/>Home</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></div></header><div id=header-post><span id=menu><div id=toc><nav id=TableOfContents><ul><li><a href=#现象>现象</a></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Cocos Creator 3.3 版本写 2D 游戏，点击事件无反应</h1><div class=meta><div class=postdate><time datetime="2021-09-20 11:30:38 +0800 CST" itemprop=datePublished>2021-09-20</time></div><div class=article-read-time><i class="far fa-clock"></i>
7 minute read</div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/cocos-creator rel=tag>Cocos Creator</a></div></div></header><div class=content itemprop=articleBody><p>周末闲来无事，学习下 Cocos Creator 3.3 (以下简称 CC)，之前接触的版本是 2.X。3.X 最大的改变是合并了 CC 3D 这个项目，官方的介绍是</p><blockquote><p>Cocos Creator 3.0 集成了原有 2D 和 3D 两套产品的所有功能，带来了诸多重大更新，将做为 Creator 之后的主力版本。同时 v3.0 还延续了 Cocos 在 2D 品类上轻量高效的优势，并且为 3D 重度游戏提供高效的开发体验。 <a href=https://docs.cocos.com/creator/3.0/manual/zh/release-notes/upgrade-guide-v3.0.html>来源</a></p></blockquote><p>相较于 2D 游戏的 x & y 轴， 3D 游戏多了 z 轴的概念，<del>毕竟是 3D 空间</del></p><h2 id=现象>现象</h2><p>在写游戏中，经常需要给某个节点增加一个缓动的动画，基本上是这么写</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=nx>tween</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>node</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>to</span><span class=p>(</span><span class=mi>5</span> <span class=o>/</span> <span class=mi>24</span><span class=p>,</span> <span class=p>{</span> <span class=nx>scale</span>: <span class=kt>new</span> <span class=nx>math</span><span class=p>.</span><span class=nx>Vec3</span><span class=p>(</span><span class=mf>1.1</span><span class=p>,</span> <span class=mf>1.1</span><span class=p>)</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>to</span><span class=p>(</span><span class=mi>5</span> <span class=o>/</span> <span class=mi>24</span><span class=p>,</span> <span class=p>{</span> <span class=nx>scale</span>: <span class=kt>new</span> <span class=nx>math</span><span class=p>.</span><span class=nx>Vec3</span><span class=p>(</span><span class=mf>1.0</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>)</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>start</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>这就是一个很普通的放大再缩小的动画，但在这个动画被出发之后，我发现这个节点的点击事件不好使了。 本来以为是哪个把这个节点上 Button 组件设置为禁止点击了。但通过删除相关代码，延迟打印<code>interactable</code>，结果都是证明了，这个组件没有问题。</p><p>随后，给 Button 组件[<a href=https://github.com/cocos-creator/engine/blob/v3.3.2/cocos/ui/button.ts>cocos/ui/button.ts</a>] 的点击事件打断点</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>788
</span><span class=lnt>789
</span><span class=lnt>790
</span><span class=lnt>791
</span><span class=lnt>792
</span><span class=lnt>793
</span><span class=lnt>794
</span><span class=lnt>795
</span><span class=lnt>796
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>protected</span> <span class=nx>_onTouchBegan</span> <span class=p>(</span><span class=nx>event?</span>: <span class=kt>EventTouch</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>_interactable</span> <span class=o>||</span> <span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>enabledInHierarchy</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_pressed</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_updateState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>event</span><span class=p>.</span><span class=nx>propagationStopped</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>发现这个断电未生效， 这个方法没有被触发到，所以就导致了点击事件没有被派发出来。</p><p>那就很神奇了， 于是就顺着找，找到了派发点击事件的地方 [<a href=https://github.com/cocos-creator/engine/blob/v3.3.2/cocos/core/scene-graph/node-event-processor.ts>cocos/core/scene-graph/node-event-processor.ts</a>]</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>function</span> <span class=nx>_touchStartHandler</span> <span class=p>(</span><span class=k>this</span><span class=o>:</span> <span class=nx>EventListener</span><span class=p>,</span> <span class=nx>touch</span>: <span class=kt>Touch</span><span class=p>,</span> <span class=nx>event</span>: <span class=kt>EventTouch</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>node</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>owner</span> <span class=kr>as</span> <span class=nx>Node</span> <span class=o>|</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>node</span> <span class=o>||</span> <span class=o>!</span><span class=nx>node</span><span class=p>.</span><span class=nx>_uiProps</span><span class=p>.</span><span class=nx>uiTransformComp</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>touch</span><span class=p>.</span><span class=nx>getUILocation</span><span class=p>(</span><span class=nx>pos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>_uiProps</span><span class=p>.</span><span class=nx>uiTransformComp</span><span class=p>.</span><span class=nx>isHit</span><span class=p>(</span><span class=nx>pos</span><span class=p>,</span> <span class=k>this</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>event</span><span class=p>.</span><span class=kr>type</span> <span class=o>=</span> <span class=nx>SystemEventType</span><span class=p>.</span><span class=nx>TOUCH_START</span><span class=p>.</span><span class=nx>toString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nx>event</span><span class=p>.</span><span class=nx>touch</span> <span class=o>=</span> <span class=nx>touch</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>event</span><span class=p>.</span><span class=nx>bubbles</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>node</span><span class=p>.</span><span class=nx>dispatchEvent</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>继续打断点，发现点击开始的事件收到了，但在<code>74</code>行的<code>isHit(pos, this)</code>判断中，走了<code>else</code>分支，因此导致这个事件没有从<code>node</code>上派发出去。</p><p><code>isHit</code>是 uiTransform [<a href=https://github.com/cocos-creator/engine/blob/v3.3.2/cocos/2d/framework/ui-transform.ts>cocos/2d/framework/ui-transform.ts</a>] 的一个方法，用于计算当前节点的点击。(代码比较多，就只展示出问题的一部分)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>407
</span><span class=lnt>408
</span><span class=lnt>409
</span><span class=lnt>410
</span><span class=lnt>411
</span><span class=lnt>412
</span><span class=lnt>413
</span><span class=lnt>414
</span><span class=lnt>415
</span><span class=lnt>416
</span><span class=lnt>417
</span><span class=lnt>418
</span><span class=lnt>419
</span><span class=lnt>420
</span><span class=lnt>421
</span><span class=lnt>422
</span><span class=lnt>423
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=c1>// 将一个摄像机坐标系下的点转换到世界坐标系下
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>camera</span><span class=p>.</span><span class=nx>node</span><span class=p>.</span><span class=nx>getWorldRT</span><span class=p>(</span><span class=nx>_mat4_temp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>m12</span> <span class=o>=</span> <span class=nx>_mat4_temp</span><span class=p>.</span><span class=nx>m12</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>m13</span> <span class=o>=</span> <span class=nx>_mat4_temp</span><span class=p>.</span><span class=nx>m13</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>center</span> <span class=o>=</span> <span class=nx>legacyCC</span><span class=p>.</span><span class=nx>visibleRect</span><span class=p>.</span><span class=nx>center</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>_mat4_temp</span><span class=p>.</span><span class=nx>m12</span> <span class=o>=</span> <span class=nx>center</span><span class=p>.</span><span class=nx>x</span> <span class=o>-</span> <span class=p>(</span><span class=nx>_mat4_temp</span><span class=p>.</span><span class=nx>m00</span> <span class=o>*</span> <span class=nx>m12</span> <span class=o>+</span> <span class=nx>_mat4_temp</span><span class=p>.</span><span class=nx>m04</span> <span class=o>*</span> <span class=nx>m13</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>_mat4_temp</span><span class=p>.</span><span class=nx>m13</span> <span class=o>=</span> <span class=nx>center</span><span class=p>.</span><span class=nx>y</span> <span class=o>-</span> <span class=p>(</span><span class=nx>_mat4_temp</span><span class=p>.</span><span class=nx>m01</span> <span class=o>*</span> <span class=nx>m12</span> <span class=o>+</span> <span class=nx>_mat4_temp</span><span class=p>.</span><span class=nx>m05</span> <span class=o>*</span> <span class=nx>m13</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>Mat4</span><span class=p>.</span><span class=nx>invert</span><span class=p>(</span><span class=nx>_mat4_temp</span><span class=p>,</span> <span class=nx>_mat4_temp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>Vec2</span><span class=p>.</span><span class=nx>transformMat4</span><span class=p>(</span><span class=nx>cameraPt</span><span class=p>,</span> <span class=nx>point</span><span class=p>,</span> <span class=nx>_mat4_temp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>this</span><span class=p>.</span><span class=nx>node</span><span class=p>.</span><span class=nx>getWorldMatrix</span><span class=p>(</span><span class=nx>_worldMatrix</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>Mat4</span><span class=p>.</span><span class=nx>invert</span><span class=p>(</span><span class=nx>_mat4_temp</span><span class=p>,</span> <span class=nx>_worldMatrix</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>Mat4</span><span class=p>.</span><span class=nx>strictEquals</span><span class=p>(</span><span class=nx>_mat4_temp</span><span class=p>,</span> <span class=nx>_zeroMatrix</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></td></tr></table></div></div><p>通过断点一步一步的检查， 发现程序进入了<code>420</code>行的<code>if</code>分支。做了下交叉对比，在没有播放上面的缓动动画之前，这里是没问题的，播放之后就进入了这个分支。</p><p>那肯定是变量值有问题，比对后发现<code>_worldMatrix</code>的第 11 位 (m10，第 3 行，第 3 列) 不一致。</p><hr><p>播放动画之前</p><table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>1</td><td>0</td><td>0</td><td>0</td></tr><tr><td>0</td><td>1</td><td>0</td><td>0</td></tr><tr><td>0</td><td>0</td><td>1</td><td>0</td></tr><tr><td>-555</td><td>-884</td><td>0</td><td>1</td></tr></tbody></table><hr><p>播放动画之后</p><table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>1</td><td>0</td><td>0</td><td>0</td></tr><tr><td>0</td><td>1</td><td>0</td><td>0</td></tr><tr><td>0</td><td>0</td><td>0</td><td>0</td></tr><tr><td>-555</td><td>-884</td><td>0</td><td>1</td></tr></tbody></table><p>然后将第二组 Matrix 带入计算器，去计算 Invert Matrix，确实不存在，所以导致<code>Mat4.strictEquals(_mat4_temp, _zeroMatrix)</code>成立。</p><p>那下面的问题就是，什么导致了 m10 位变成了 0，以及，猜想是否正确。</p><hr><p>在调用 Node 的<code>getWorldMatrix</code>方法时，会先调用<code>updateWorldTransform</code>更新节点的世界变换信息，里面处理 Rotation & Scale 引起了注意。.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>569
</span><span class=lnt>570
</span><span class=lnt>571
</span><span class=lnt>572
</span><span class=lnt>573
</span><span class=lnt>574
</span><span class=lnt>575
</span><span class=lnt>576
</span><span class=lnt>577
</span><span class=lnt>578
</span><span class=lnt>579
</span><span class=lnt>580
</span><span class=lnt>581
</span><span class=lnt>582
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>dirtyBits</span> <span class=o>&amp;</span> <span class=nx>TransformBit</span><span class=p>.</span><span class=nx>RS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Mat4</span><span class=p>.</span><span class=nx>fromRTS</span><span class=p>(</span><span class=nx>child</span><span class=p>.</span><span class=nx>_mat</span><span class=p>,</span> <span class=nx>child</span><span class=p>.</span><span class=nx>_lrot</span><span class=p>,</span> <span class=nx>child</span><span class=p>.</span><span class=nx>_lpos</span><span class=p>,</span> <span class=nx>child</span><span class=p>.</span><span class=nx>_lscale</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>Mat4</span><span class=p>.</span><span class=nx>multiply</span><span class=p>(</span><span class=nx>child</span><span class=p>.</span><span class=nx>_mat</span><span class=p>,</span> <span class=nx>cur</span><span class=p>.</span><span class=nx>_mat</span><span class=p>,</span> <span class=nx>child</span><span class=p>.</span><span class=nx>_mat</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>dirtyBits</span> <span class=o>&amp;</span> <span class=nx>TransformBit</span><span class=p>.</span><span class=nx>ROTATION</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Quat</span><span class=p>.</span><span class=nx>multiply</span><span class=p>(</span><span class=nx>child</span><span class=p>.</span><span class=nx>_rot</span><span class=p>,</span> <span class=nx>cur</span><span class=p>.</span><span class=nx>_rot</span><span class=p>,</span> <span class=nx>child</span><span class=p>.</span><span class=nx>_lrot</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>NodePool</span><span class=p>.</span><span class=nx>setVec4</span><span class=p>(</span><span class=nx>child</span><span class=p>.</span><span class=nx>_poolHandle</span><span class=p>,</span> <span class=nx>NodeView</span><span class=p>.</span><span class=nx>WORLD_ROTATION</span><span class=p>,</span> <span class=nx>child</span><span class=p>.</span><span class=nx>_rot</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>Mat3</span><span class=p>.</span><span class=nx>fromQuat</span><span class=p>(</span><span class=nx>m3_1</span><span class=p>,</span> <span class=nx>Quat</span><span class=p>.</span><span class=nx>conjugate</span><span class=p>(</span><span class=nx>qt_1</span><span class=p>,</span> <span class=nx>child</span><span class=p>.</span><span class=nx>_rot</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nx>Mat3</span><span class=p>.</span><span class=nx>multiplyMat4</span><span class=p>(</span><span class=nx>m3_1</span><span class=p>,</span> <span class=nx>m3_1</span><span class=p>,</span> <span class=nx>child</span><span class=p>.</span><span class=nx>_mat</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>child</span><span class=p>.</span><span class=nx>_scale</span><span class=p>.</span><span class=nx>x</span> <span class=o>=</span> <span class=nx>m3_1</span><span class=p>.</span><span class=nx>m00</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>child</span><span class=p>.</span><span class=nx>_scale</span><span class=p>.</span><span class=nx>y</span> <span class=o>=</span> <span class=nx>m3_1</span><span class=p>.</span><span class=nx>m04</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>child</span><span class=p>.</span><span class=nx>_scale</span><span class=p>.</span><span class=nx>z</span> <span class=o>=</span> <span class=nx>m3_1</span><span class=p>.</span><span class=nx>m08</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>NodePool</span><span class=p>.</span><span class=nx>setVec3</span><span class=p>(</span><span class=nx>child</span><span class=p>.</span><span class=nx>_poolHandle</span><span class=p>,</span> <span class=nx>NodeView</span><span class=p>.</span><span class=nx>WORLD_SCALE</span><span class=p>,</span> <span class=nx>child</span><span class=p>.</span><span class=nx>_scale</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>Mat4.fromRTS(child._mat, child._lrot, child._lpos, child._lscale);</code>里存在<code>m10</code>计算的过程,</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>public</span> <span class=kr>static</span> <span class=nx>fromRTS</span><span class=p>(</span><span class=nx>out</span>: <span class=kt>Out</span><span class=p>,</span> <span class=nx>q</span>: <span class=kt>Quat</span><span class=p>,</span> <span class=nx>v</span>: <span class=kt>VecLike</span><span class=p>,</span> <span class=nx>s</span>: <span class=kt>VecLike</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>sz</span> <span class=o>=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>z</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=nx>out</span><span class=p>.</span><span class=nx>m10</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=p>(</span><span class=nx>xx</span> <span class=o>+</span> <span class=nx>yy</span><span class=p>))</span> <span class=o>*</span> <span class=nx>sz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>而变量<code>s</code>正是这个节点的缩放信息。</p><p>那问题出在那里就很明确了，如果该节点的<code>z-Scale</code>等于<code>0</code>，那<code>m10</code>必然会等于<code>0</code>，再回过头看之前写的缓动动画</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=nx>tween</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>node</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>to</span><span class=p>(</span><span class=mi>5</span> <span class=o>/</span> <span class=mi>24</span><span class=p>,</span> <span class=p>{</span> <span class=nx>scale</span>: <span class=kt>new</span> <span class=nx>math</span><span class=p>.</span><span class=nx>Vec3</span><span class=p>(</span><span class=mf>1.1</span><span class=p>,</span> <span class=mf>1.1</span><span class=p>)</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>to</span><span class=p>(</span><span class=mi>5</span> <span class=o>/</span> <span class=mi>24</span><span class=p>,</span> <span class=p>{</span> <span class=nx>scale</span>: <span class=kt>new</span> <span class=nx>math</span><span class=p>.</span><span class=nx>Vec3</span><span class=p>(</span><span class=mf>1.0</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>)</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>start</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>巧了，Vec3 对象，就没设置 z 上的信息，而 Vec3 的初始值又是 0，也就导致了以上一连串的问题</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>constructor</span> <span class=p>(</span><span class=nx>x?</span>: <span class=kt>number</span> <span class=o>|</span> <span class=nx>Vec3</span><span class=p>,</span> <span class=nx>y?</span>: <span class=kt>number</span><span class=p>,</span> <span class=nx>z?</span>: <span class=kt>number</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>super</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>x</span> <span class=o>&amp;&amp;</span> <span class=k>typeof</span> <span class=nx>x</span> <span class=o>===</span> <span class=s1>&#39;object&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>x</span> <span class=o>=</span> <span class=nx>x</span><span class=p>.</span><span class=nx>x</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>y</span> <span class=o>=</span> <span class=nx>x</span><span class=p>.</span><span class=nx>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>z</span> <span class=o>=</span> <span class=nx>x</span><span class=p>.</span><span class=nx>z</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>x</span> <span class=o>=</span> <span class=nx>x</span> <span class=o>||</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>y</span> <span class=o>=</span> <span class=nx>y</span> <span class=o>||</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>z</span> <span class=o>=</span> <span class=nx>z</span> <span class=o>||</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>2D 游戏没有第三个轴 Z，因此这个轴上的信息并不能反馈到画面上，但 CC 底层计算又会考虑这些。</p><p>后续的修改方案就简单了，也不能复现出问题了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=nx>tween</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>node</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>to</span><span class=p>(</span><span class=mi>5</span> <span class=o>/</span> <span class=mi>24</span><span class=p>,</span> <span class=p>{</span> <span class=nx>scale</span>: <span class=kt>new</span> <span class=nx>math</span><span class=p>.</span><span class=nx>Vec3</span><span class=p>(</span><span class=mf>1.1</span><span class=p>,</span> <span class=mf>1.1</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>)</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>to</span><span class=p>(</span><span class=mi>5</span> <span class=o>/</span> <span class=mi>24</span><span class=p>,</span> <span class=p>{</span> <span class=nx>scale</span>: <span class=kt>new</span> <span class=nx>math</span><span class=p>.</span><span class=nx>Vec3</span><span class=p>(</span><span class=mf>1.0</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>)</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=nx>start</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div></div></article><footer id=footer><div class=footer-left>Copyright &copy; 2024 Hugh(Hui) Liu</div><script src=https://code.iconify.design/2/2.0.4/iconify.min.js></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "7f02cdd7074d4e1f8125c11651f47699"}'></script></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>