<!doctype html><html lang=zh-cn><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>修复 Cocos Creator 加载资源过慢 | RanKKI's Blog</title>
<link rel=canonical href=https://rankki.xyz/posts/cocos-creator-slow-resources-load/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://rankki.xyz/posts/cocos-creator-slow-resources-load/"><meta property="og:site_name" content="RanKKI's Blog"><meta property="og:title" content="修复 Cocos Creator 加载资源过慢"><meta property="og:description" content="在写 Cocos Creator 2.4.6 项目时候 (以下简称 CC)，需要增加一些反馈的音效。比如说按钮点击时，播放动画时。但在处理播放声音的时候，遇到个奇怪的问题。在有些设备上，声音一直会有延迟，感觉上来说，少则 100ms 多则 500ms，这点的体验就十分的差了，也是完全不能接受的。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-10T11:56:35+08:00"><meta property="article:modified_time" content="2023-05-05T11:33:16+10:00"><meta property="article:tag" content="Cocos Creator"><meta name=twitter:card content="summary"><meta name=twitter:title content="修复 Cocos Creator 加载资源过慢"><meta name=twitter:description content="在写 Cocos Creator 2.4.6 项目时候 (以下简称 CC)，需要增加一些反馈的音效。比如说按钮点击时，播放动画时。但在处理播放声音的时候，遇到个奇怪的问题。在有些设备上，声音一直会有延迟，感觉上来说，少则 100ms 多则 500ms，这点的体验就十分的差了，也是完全不能接受的。"><link rel=stylesheet href=https://rankki.xyz/css/styles.703587cbc83e3d6c4abb083f3126cd73c5c67af0782c70bbc9e4643c1d171ec879a51fed1fd12cf82e0469fc4c2454f83d63696957494d2268aa2cc691a4ef06.css><link rel=stylesheet href=https://rankki.xyz/css/syntax.css><link rel=stylesheet href=https://rankki.xyz/css/loading.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://rankki.xyz/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://rankki.xyz/><div id=title><h1>RanKKI's Blog</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/>Home</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></div></header><div id=header-post><span id=menu><div id=toc><nav id=TableOfContents></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">修复 Cocos Creator 加载资源过慢</h1><div class=meta><div class=postdate><time datetime="2021-09-10 11:56:35 +0800 CST" itemprop=datePublished>2021-09-10</time>
(Updated: <time datetime="2023-05-05 11:33:16 +1000 +1000" itemprop=dateModified>2023-05-05</time>)</div><div class=article-read-time><i class="far fa-clock"></i>
3 minute read</div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/cocos-creator rel=tag>Cocos Creator</a></div></div></header><div class=content itemprop=articleBody><p>在写 Cocos Creator 2.4.6 项目时候 (以下简称 CC)，需要增加一些反馈的音效。比如说按钮点击时，播放动画时。但在处理播放声音的时候，遇到个奇怪的问题。在有些设备上，声音一直会有延迟，感觉上来说，少则 100ms 多则 500ms，这点的体验就十分的差了，也是完全不能接受的。</p><p>这个项目是打包成微信小游戏的，所有资源都在包内，不存在远程加载的问题。</p><p>但，CC 不可能不对资源进行缓存，同时资源也是在本地，按道理来说，不应该会这么慢。第一次慢能理解，毕竟要进行加载，但二次应当是无感的。</p><hr><h1 id=tldr>TLDR;</h1><p>CC 在资源加载 <code>cc.resources.load</code> 执行了太多操作。 设计上十分的粗燥。在加载已经加载过的资源时，CC 在取缓存之前做了太多无意义的操作。因此，解决方案是自己在业务层手动封装一个 <code>loadRes</code> 之类的方法，直接那文件的 uuid，然后从 assets 里通过 uuid 拿资源，不走 CC 自己的那一套。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>loadRes</span><span class=p>&lt;</span><span class=nt>T</span> <span class=na>extends</span> <span class=na>cc.Asset</span><span class=p>&gt;(</span><span class=nx>path</span>: <span class=kt>string</span><span class=p>,</span> <span class=kr>type</span><span class=o>:</span> <span class=k>typeof</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>Asset</span><span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>path</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>bundle</span> <span class=o>=</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>resources</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>bundleName</span> <span class=o>=</span> <span class=s2>&#34;resources&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>bundle</span><span class=p>.</span><span class=nx>getInfoWithPath</span><span class=p>(</span><span class=nx>path</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>bundleName</span> <span class=o>=</span> <span class=s2>&#34;remote&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nx>bundle</span> <span class=o>=</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>assetManager</span><span class=p>.</span><span class=nx>getBundle</span><span class=p>(</span><span class=nx>bundleName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>bundle</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>bundle</span> <span class=o>=</span> <span class=k>await</span> <span class=k>new</span> <span class=nx>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>cc</span><span class=p>.</span><span class=nx>assetManager</span><span class=p>.</span><span class=nx>loadBundle</span><span class=p>(</span><span class=nx>bundleName</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>bundle</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>err</span> <span class=o>?</span> <span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>:</span> <span class=nx>resolve</span><span class=p>(</span><span class=nx>bundle</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>getResFromBundle</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;(</span><span class=nx>bundleName</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=kr>type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nx>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>bundle</span><span class=p>.</span><span class=nx>load</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span> <span class=kr>type</span><span class=p>,</span> <span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=nx>asset</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>err</span> <span class=o>?</span> <span class=nx>reject</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=o>:</span> <span class=nx>resolve</span><span class=p>(</span><span class=nx>asset</span> <span class=kr>as</span> <span class=nx>T</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>getResFromBundle</span><span class=p>&lt;</span><span class=nt>T</span> <span class=na>extends</span> <span class=na>cc.Asset</span><span class=p>&gt;(</span><span class=nx>bundle</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>path</span>: <span class=kt>string</span><span class=p>,</span> <span class=kr>type</span><span class=o>:</span> <span class=k>typeof</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>Asset</span><span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>T</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>path</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>uuid</span> <span class=o>=</span> <span class=nx>pathToUUID</span><span class=p>(</span><span class=nx>bundle</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=kr>type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>uuid</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>assetManager</span><span class=p>.</span><span class=nx>assets</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>uuid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>res</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span> <span class=kr>as</span> <span class=nx>T</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>pathToUUID</span><span class=p>(</span><span class=nx>bundleName</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>path</span>: <span class=kt>string</span><span class=p>,</span> <span class=kr>type</span><span class=o>:</span> <span class=k>typeof</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>Asset</span><span class=p>)</span><span class=o>:</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>bundles</span> <span class=o>=</span> <span class=nx>cc</span><span class=p>.</span><span class=nx>assetManager</span><span class=p>.</span><span class=nx>bundles</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>getFromBundle</span> <span class=o>=</span> <span class=p>(</span><span class=nx>name</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=kt>string</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>bundles</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>name</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>bundle</span> <span class=o>=</span> <span class=nx>bundles</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>info</span> <span class=o>=</span> <span class=nx>bundle</span><span class=p>.</span><span class=nx>getInfoWithPath</span><span class=p>(</span><span class=nx>path</span><span class=p>,</span> <span class=kr>type</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>info</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>info</span><span class=p>.</span><span class=nx>redirect</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>getFromBundle</span><span class=p>(</span><span class=nx>info</span><span class=p>.</span><span class=nx>redirect</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>info</span><span class=p>.</span><span class=nx>uuid</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>getFromBundle</span><span class=p>(</span><span class=nx>bundleName</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></div></article><footer id=footer><div class=footer-left>Copyright &copy; 2024 Hugh(Hui) Liu</div><script src=https://code.iconify.design/2/2.0.4/iconify.min.js></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "7f02cdd7074d4e1f8125c11651f47699"}'></script></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>