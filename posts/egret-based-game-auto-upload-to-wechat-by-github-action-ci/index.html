<!doctype html><html lang=zh-cn><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>自动发布白鹭引擎小游戏到微信平台 CI/CD | RanKKI's Blog</title>
<link rel=canonical href=https://rankki.xyz/posts/egret-based-game-auto-upload-to-wechat-by-github-action-ci/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://rankki.xyz/posts/egret-based-game-auto-upload-to-wechat-by-github-action-ci/"><meta property="og:site_name" content="RanKKI's Blog"><meta property="og:title" content="自动发布白鹭引擎小游戏到微信平台 CI/CD"><meta property="og:description" content="最近一段时间在使用白鹭 Egret Engine，为了统一和方便，选择使用 GitHub Action 做 CI/CD，但在折腾的过程中，发现了很多坑。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-14T18:30:36+08:00"><meta property="article:modified_time" content="2021-09-18T18:42:24+08:00"><meta property="article:tag" content="Egret"><meta property="article:tag" content="WeChat"><meta property="article:tag" content="CI/CD"><meta name=twitter:card content="summary"><meta name=twitter:title content="自动发布白鹭引擎小游戏到微信平台 CI/CD"><meta name=twitter:description content="最近一段时间在使用白鹭 Egret Engine，为了统一和方便，选择使用 GitHub Action 做 CI/CD，但在折腾的过程中，发现了很多坑。"><link rel=stylesheet href=https://rankki.xyz/css/styles.703587cbc83e3d6c4abb083f3126cd73c5c67af0782c70bbc9e4643c1d171ec879a51fed1fd12cf82e0469fc4c2454f83d63696957494d2268aa2cc691a4ef06.css><link rel=stylesheet href=https://rankki.xyz/css/syntax.css><link rel=stylesheet href=https://rankki.xyz/css/loading.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://rankki.xyz/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://rankki.xyz/><div id=title><h1>RanKKI's Blog</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/>Home</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></div></header><div id=header-post><span id=menu><div id=toc><nav id=TableOfContents></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">自动发布白鹭引擎小游戏到微信平台 CI/CD</h1><div class=meta><div class=postdate><time datetime="2021-07-14 18:30:36 +0800 CST" itemprop=datePublished>2021-07-14</time>
(Updated: <time datetime="2021-09-18 18:42:24 +0800 CST" itemprop=dateModified>2021-09-18</time>)</div><div class=article-read-time><i class="far fa-clock"></i>
4 minute read</div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/egret rel=tag>Egret</a>
,
<a class=tag-link href=/tags/wechat rel=tag>WeChat</a>
,
<a class=tag-link href=/tags/ci/cd rel=tag>CI/CD</a></div></div></header><div class=content itemprop=articleBody><p>最近一段时间在使用白鹭 Egret Engine，为了统一和方便，选择使用 GitHub Action 做 CI/CD，但在折腾的过程中，发现了很多坑。</p><blockquote><p>生命在于折腾</p></blockquote><p>首先要知道的事，微信小程序是有一个 <code>miniprogram-ci</code> 的包用于上传项目到平台，而且在微信后台看是不同的开发者，也就意味着可以使用这个 bot 打包不同的版本。(ci 工具支持最多 30 个 bot) <a href=https://developers.weixin.qq.com/miniprogram/dev/devtools/ci.html>文档 *</a></p><blockquote><p>npm install miniprogram-ci</p></blockquote><p>有了这个 ci 工具其实解决了最大的难题，（尽管我们可以通过 gui 版的微信开发者工具上传，但很难处理 token 之类的问题）</p><p>下一个要解决的难题是，编译白鹭项目成微信，我想着这部分会很简单，安装一下白鹭引擎，再<code>egret publish --target wxgame</code>就解决了，但没想到这一步卡了很久。</p><hr><p>得益于白鹭引擎是个在 GitHub 开源的项目，可以直接使用 <a href=https://github.com/actions/checkout><code>actions/checkout</code></a> 拿到白鹭的项目，以及要把自己的项目 <code>checkout</code> 出来，</p><pre tabindex=0><code>- name: Checkout Egret Engine
  uses: actions/checkout@v2
  with:
    repository: egret-labs/egret-core
    ref: &#34;v5.4.1&#34;
    path: &#34;engine&#34;
</code></pre><blockquote><p>如果是私人项目 (private repo)，那需要在设置里生成一个 PAT (Personal Access Token) 并通过项目设置中的密钥 (Secrets) 传入到 ci 脚本中。</p></blockquote><p>本以为事情到这里就结束了，使用白鹭的脚本打包，使用微信的 CI 上传，万事大吉。</p><p>然而，白鹭编译的过程中需要白鹭自己的 Compiler 去打包，一番研究，白鹭有把 egret compiler 发布到 npm 上，可以直接 <code>npm install @egret/eui-compiler@1.4.9</code> 安装。</p><p>但，这还不够，在运行的时候，会报缺少 <code>egret-webpack-bundler</code> 的错误，找了一圈发现也可以通过 <code>npm install @egret/egret-webpack-bundler</code> 安装。</p><p>本以为事情到这里就结束了 again。</p><p>发现还是会有报错，目录问题。 好在是个开源项目，直接读 <code>egret compiler</code> 的源码，竟然是写死的目录！于是只能通过各种 <code>mkdir</code>, <code>mv</code> 模拟成 egret compiler 希望使用的。</p><p>后面的事情就简单了，配置下微信 CI 工具，包括版本号，appID，密钥等信息</p><hr><blockquote><p>CI 脚本写的比较乱 :)</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>WxGame CI</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>push</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>branches</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=l>master ]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>matrix</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>node-version</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=m>16.</span><span class=l>x]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Step Node.js ${{ matrix.node-version }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/setup-node@v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>node-version</span><span class=p>:</span><span class=w> </span><span class=l>${{ matrix.node-version }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Checkout Egret Engine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>egret-labs/egret-core</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ref</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;v5.4.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;engine&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Checkout Project</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>repo-author/project]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ref</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;master&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;./project/&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.PAT }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Preparing miniprogram ci</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>npm install miniprogram-ci @egret/egret-library-installer -g</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Rearrange folder&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        mkdir -p /home/runner/.egret/engine/5.4.1
</span></span></span><span class=line><span class=cl><span class=sd>        mkdir -p /tmp/project
</span></span></span><span class=line><span class=cl><span class=sd>        mv ./engine/* /home/runner/.egret/engine/5.4.1/
</span></span></span><span class=line><span class=cl><span class=sd>        mv ./project/* /tmp/project/</span><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install egret compiler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        mkdir -p /tmp/egret/compiler/EgretLauncher/download/EgretCompiler
</span></span></span><span class=line><span class=cl><span class=sd>        cd /tmp/egret/compiler/EgretLauncher/download/EgretCompiler
</span></span></span><span class=line><span class=cl><span class=sd>        npm install --prefix . @egret/egret-webpack-bundler@2.0.3 @egret/eui-compiler@1.4.9
</span></span></span><span class=line><span class=cl><span class=sd>        mv ./node_modules/@egret .
</span></span></span><span class=line><span class=cl><span class=sd>        cd @egret/egret-webpack-bundler
</span></span></span><span class=line><span class=cl><span class=sd>        npm install @egret/texture-merger-core</span><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Building project</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        npm install --prefix /tmp/project/scripts uglify-js
</span></span></span><span class=line><span class=cl><span class=sd>        /home/runner/.egret/engine/5.4.1/tools/bin/egret publish /tmp/project --target wxgame</span><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>EGRET_PATH</span><span class=p>:</span><span class=w> </span><span class=l>/home/runner/.egret/engine/5.4.1/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>XDG_CONFIG_HOME</span><span class=p>:</span><span class=w> </span><span class=l>/tmp/egret/compiler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Generate private key for upload</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>echo &#34;$WX_UPLOAD_PRIVATE_KEY&#34; &gt; private.key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>WX_UPLOAD_PRIVATE_KEY</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.WX_UPLOAD_PRIVATE_KEY }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>uploading project</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>miniprogram-ci upload --pp /tmp/project/wxgame --pkp ./private.key --appid APP_ID --uv APP_VERSION --ud &#34;${{ github.event.head_commit.message }}&#34; -r 1 --enable-es6 true  --pt miniGame</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></div></article><footer id=footer><div class=footer-left>Copyright &copy; 2024 Hugh(Hui) Liu</div><script src=https://code.iconify.design/2/2.0.4/iconify.min.js></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "7f02cdd7074d4e1f8125c11651f47699"}'></script></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>