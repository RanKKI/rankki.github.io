<!doctype html><html lang=zh-cn><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Golang Gin 框架 Middleware | RanKKI's Blog</title>
<link rel=canonical href=https://rankki.xyz/posts/golang-gin-middleware/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://rankki.xyz/posts/golang-gin-middleware/"><meta property="og:site_name" content="RanKKI's Blog"><meta property="og:title" content="Golang Gin 框架 Middleware"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-06-30T09:51:35+00:00"><meta property="article:modified_time" content="2021-09-18T18:42:24+08:00"><meta property="article:tag" content="Golang"><meta property="article:tag" content="Gin"><meta name=twitter:card content="summary"><meta name=twitter:title content="Golang Gin 框架 Middleware"><link rel=stylesheet href=https://rankki.xyz/css/styles.703587cbc83e3d6c4abb083f3126cd73c5c67af0782c70bbc9e4643c1d171ec879a51fed1fd12cf82e0469fc4c2454f83d63696957494d2268aa2cc691a4ef06.css><link rel=stylesheet href=https://rankki.xyz/css/syntax.css><link rel=stylesheet href=https://rankki.xyz/css/loading.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://rankki.xyz/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://rankki.xyz/><div id=title><h1>RanKKI's Blog</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/>Home</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></div></header><div id=header-post><span id=menu><div id=toc><nav id=TableOfContents></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Golang Gin 框架 Middleware</h1><div class=meta><div class=postdate><time datetime="2020-06-30 09:51:35 +0000 UTC" itemprop=datePublished>2020-06-30</time>
(Updated: <time datetime="2021-09-18 18:42:24 +0800 CST" itemprop=dateModified>2021-09-18</time>)</div><div class=article-read-time><i class="far fa-clock"></i>
3 minute read</div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/golang rel=tag>Golang</a>
,
<a class=tag-link href=/tags/gin rel=tag>Gin</a></div></div></header><div class=content itemprop=articleBody><p>最近在学习 Golang + Gin + Vue.js 的项目，在处理 CORS 跨域问题上发现了个不算坑的坑。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=nf>New</span><span class=p>()</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Engine</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>router</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nf>registerPostApis</span><span class=p>(</span><span class=nx>router</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>registerUserApis</span><span class=p>(</span><span class=nx>router</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>router</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>cors</span><span class=p>.</span><span class=nf>Default</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>router</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个是我一开始写的，然后发现不管是用 Gin 官方的 CORS 中间件，还是自己写一个 CORS 中间件，在前端 Vue.js 用 axios 调用的时候，会出现</p><blockquote><p>cross-Origin Request Blocked: The Same Origin Policy disallows reading the remote
resource at http://127.0.0.1:8081/user/login. (Reason: CORS header ‘Access-Control-Allow-Origin’ missing).</p></blockquote><p>但这不应该，我都有设置好 <code>Access-Control-Allow-Origin</code>, <code>Access-Control-Allow-Header</code>等 Headers</p><p>通过抓包也能看到 response 里面没有这些信息</p><p>然后，我把中间件放到了注册路由的前面，即</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=nf>New</span><span class=p>()</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Engine</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>router</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>Default</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>router</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>cors</span><span class=p>.</span><span class=nf>Default</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nf>registerPostApis</span><span class=p>(</span><span class=nx>router</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>registerUserApis</span><span class=p>(</span><span class=nx>router</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>router</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>一切都顺畅了，不会出现跨域的问题了。</p><p>那么，是为什么呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Default</span><span class=p>()</span> <span class=o>*</span><span class=nx>Engine</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>debugPrintWARNINGDefault</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>engine</span> <span class=o>:=</span> <span class=nf>New</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>engine</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nf>Logger</span><span class=p>(),</span> <span class=nf>Recovery</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>engine</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>engine</span> <span class=o>*</span><span class=nx>Engine</span><span class=p>)</span> <span class=nf>Use</span><span class=p>(</span><span class=nx>middleware</span> <span class=o>...</span><span class=nx>HandlerFunc</span><span class=p>)</span> <span class=nx>IRoutes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>engine</span><span class=p>.</span><span class=nx>RouterGroup</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>middleware</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>engine</span><span class=p>.</span><span class=nf>rebuild404Handlers</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>engine</span><span class=p>.</span><span class=nf>rebuild405Handlers</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>engine</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>group</span> <span class=o>*</span><span class=nx>RouterGroup</span><span class=p>)</span> <span class=nf>Use</span><span class=p>(</span><span class=nx>middleware</span> <span class=o>...</span><span class=nx>HandlerFunc</span><span class=p>)</span> <span class=nx>IRoutes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>group</span><span class=p>.</span><span class=nx>Handlers</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>group</span><span class=p>.</span><span class=nx>Handlers</span><span class=p>,</span> <span class=nx>middleware</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>group</span><span class=p>.</span><span class=nf>returnObj</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，调用 <code>engine.Use()</code>的时候，是调用了<code>engine.RouterGroup.Use()</code>，然后将中间件加入到了 <code>group.Handlers</code> 里。</p><p>而在注册路由的时候，用到了 <code>engine.Group()</code></p><blockquote><p>即使不用 <code>Group()</code>，直接用 <code>engine.GET("/URL")</code> 也是一样的</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>group</span> <span class=o>*</span><span class=nx>RouterGroup</span><span class=p>)</span> <span class=nf>Group</span><span class=p>(</span><span class=nx>relativePath</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>handlers</span> <span class=o>...</span><span class=nx>HandlerFunc</span><span class=p>)</span> <span class=o>*</span><span class=nx>RouterGroup</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>RouterGroup</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Handlers</span><span class=p>:</span> <span class=nx>group</span><span class=p>.</span><span class=nf>combineHandlers</span><span class=p>(</span><span class=nx>handlers</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>basePath</span><span class=p>:</span> <span class=nx>group</span><span class=p>.</span><span class=nf>calculateAbsolutePath</span><span class=p>(</span><span class=nx>relativePath</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>engine</span><span class=p>:</span>   <span class=nx>group</span><span class=p>.</span><span class=nx>engine</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>group</span> <span class=o>*</span><span class=nx>RouterGroup</span><span class=p>)</span> <span class=nf>combineHandlers</span><span class=p>(</span><span class=nx>handlers</span> <span class=nx>HandlersChain</span><span class=p>)</span> <span class=nx>HandlersChain</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>finalSize</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>group</span><span class=p>.</span><span class=nx>Handlers</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=nx>handlers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>finalSize</span> <span class=o>&gt;=</span> <span class=nb>int</span><span class=p>(</span><span class=nx>abortIndex</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>panic</span><span class=p>(</span><span class=s>&#34;too many handlers&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>mergedHandlers</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>HandlersChain</span><span class=p>,</span> <span class=nx>finalSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>copy</span><span class=p>(</span><span class=nx>mergedHandlers</span><span class=p>,</span> <span class=nx>group</span><span class=p>.</span><span class=nx>Handlers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>copy</span><span class=p>(</span><span class=nx>mergedHandlers</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=nx>group</span><span class=p>.</span><span class=nx>Handlers</span><span class=p>):],</span> <span class=nx>handlers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>mergedHandlers</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对于这个路由组的中间件，是把 engine 的中间件复制一份给了 mergedHandlers,
也就是把已有的中间件和新增的中间件和在一起使用了</p><p>也就是说，如果在注册路由之后，新增了一个中间件，那这个中间件不会对已经注册的路由产生效果。</p></div></article><footer id=footer><div class=footer-left>Copyright &copy; 2024 Hugh(Hui) Liu</div><script src=https://code.iconify.design/2/2.0.4/iconify.min.js></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "7f02cdd7074d4e1f8125c11651f47699"}'></script></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>