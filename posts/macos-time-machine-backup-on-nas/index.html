<!doctype html><html lang=zh-cn><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>在 NAS 上安装 TimeMachine | RanKKI's Blog</title>
<link rel=canonical href=https://rankki.xyz/posts/macos-time-machine-backup-on-nas/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://rankki.xyz/posts/macos-time-machine-backup-on-nas/"><meta property="og:site_name" content="RanKKI's Blog"><meta property="og:title" content="在 NAS 上安装 TimeMachine"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-02-20T00:36:56+00:00"><meta property="article:modified_time" content="2021-09-18T18:42:24+08:00"><meta property="article:tag" content="Apple"><meta property="article:tag" content="TimeMachine"><meta property="article:tag" content="NAS"><meta name=twitter:card content="summary"><meta name=twitter:title content="在 NAS 上安装 TimeMachine"><link rel=stylesheet href=https://rankki.xyz/css/styles.703587cbc83e3d6c4abb083f3126cd73c5c67af0782c70bbc9e4643c1d171ec879a51fed1fd12cf82e0469fc4c2454f83d63696957494d2268aa2cc691a4ef06.css><link rel=stylesheet href=https://rankki.xyz/css/syntax.css><link rel=stylesheet href=https://rankki.xyz/css/loading.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://rankki.xyz/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://rankki.xyz/><div id=title><h1>RanKKI's Blog</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/>Home</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></div></header><div id=header-post><span id=menu><div id=toc><nav id=TableOfContents><ul><li><a href=#安装>安装</a><ul><li></li></ul></li><li><a href=#配置>配置</a></li><li><a href=#完成设置>完成设置</a></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">在 NAS 上安装 TimeMachine</h1><div class=meta><div class=postdate><time datetime="2019-02-20 00:36:56 +0000 UTC" itemprop=datePublished>2019-02-20</time>
(Updated: <time datetime="2021-09-18 18:42:24 +0800 CST" itemprop=dateModified>2021-09-18</time>)</div><div class=article-read-time><i class="far fa-clock"></i>
2 minute read</div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/apple rel=tag>Apple</a>
,
<a class=tag-link href=/tags/timemachine rel=tag>TimeMachine</a>
,
<a class=tag-link href=/tags/nas rel=tag>NAS</a></div></div></header><div class=content itemprop=articleBody><h2 id=安装>安装</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo apt-get install netatalk avahi-daemon libnss-mdns
</span></span></code></pre></td></tr></table></div></div><hr><h4 id=netatalk>Netatalk</h4><blockquote><p>Netatalk is an OpenSource software package, that can be used to turn a *NIX machine into an extremely high-performance and reliable file server for Macintosh computers.
Using Netatalk&rsquo;s AFP 3.3 compliant file-server leads to significantly higher transmission speeds compared with Macs accessing a server via SaMBa/NFS while providing clients with the best possible user experience (full support for Macintosh metadata, flawlessly supporting mixed environments of classic Mac OS and OS X clients)</p></blockquote><h4 id=avahi>Avahi</h4><blockquote><p>Avahi is a system which facilitates service discovery on a local network via the mDNS/DNS-SD protocol suite. This enables you to plug your laptop or computer into a network and instantly be able to view other people who you can chat with, find printers to print to or find files being shared. Compatible technology is found in Apple MacOS X (branded &ldquo;Bonjour&rdquo; and sometimes &ldquo;Zeroconf&rdquo;).
Avahi is primarily targetted at Linux systems and ships by default in most distributions. It is not ported to Windows at this stage, but will run on many other BSD-like systems. The primary API is D-Bus and is required for usage of most of Avahi, however services can be published using an XML service definition placed in /etc/avahi/services.</p></blockquote><h4 id=mdns>mDNS</h4><blockquote><p>nss-mdns is a plugin for the GNU Name Service Switch (NSS) functionality of the GNU C Library (glibc) providing host name resolution via Multicast DNS (aka Zeroconf, aka Apple Rendezvous, aka Apple Bonjour), effectively allowing name resolution by common Unix/Linux programs in the ad-hoc mDNS domain .local.
nss-mdns provides client functionality only, which means that you have to run a mDNS responder daemon seperately from nss-mdns if you want to register the local host name via mDNS. I recommend Avahi.
nss-mdns is very lightweight (9 KByte stripped binary .so compiled with -DNDEBUG=1 -Os on i386, gcc 4.0), has no dependencies besides the glibc and requires only minimal configuration.
By default nss-mdns tries to contact a running avahi-daemon for resolving host names and addresses and making use of its superior record cacheing. Optionally nss-mdns can be compiled with a mini mDNS stack that can be used to resolve host names without a local Avahi installation. Both Avahi support and this mini mDNS stack are optional, however at least one of them needs to be enabled. If both are enabled a connection to Avahi is tried first, and if that fails the mini mDNS stack is used.</p></blockquote><h2 id=配置>配置</h2><p>修改 Netatalke 文件。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo vim /etc/netatalk/AppleVolumes.default
</span></span></code></pre></td></tr></table></div></div><p>在文件底部加入 <code>[Folder] [Name] options:tm</code> ，比如我的 <code>\mnt\data\timemachine "Time Machine Backup" options:tm</code></p><p>然后新建一个 Avahi 服务</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo vim /etc/avahi/services/afpd.service
</span></span></code></pre></td></tr></table></div></div><p>输入一下内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; standalone=&#39;no&#39;?&gt;</span><span class=c>&lt;!--*-nxml-*--&gt;</span>
</span></span><span class=line><span class=cl><span class=cp>&lt;!DOCTYPE service-group SYSTEM &#34;avahi-service.dtd&#34;&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;service-group&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;name</span> <span class=na>replace-wildcards=</span><span class=s>&#34;yes&#34;</span><span class=nt>&gt;</span>%h<span class=nt>&lt;/name&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;service&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;type&gt;</span>_afpovertcp._tcp<span class=nt>&lt;/type&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;port&gt;</span>548<span class=nt>&lt;/port&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/service&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;service&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;type&gt;</span>_device-info._tcp<span class=nt>&lt;/type&gt;</span>
</span></span><span class=line><span class=cl> 	       <span class=nt>&lt;port&gt;</span>0<span class=nt>&lt;/port&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;txt-record&gt;</span>model=Xserve<span class=nt>&lt;/txt-record&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/service&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/service-group&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>修改 nss-mdns 配置文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo vim /etc/nsswitch.conf
</span></span></code></pre></td></tr></table></div></div><p>在 hosts 后面加入 mdns4 和 mdns</p><h2 id=完成设置>完成设置</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo service netatalk restart
</span></span><span class=line><span class=cl>$ sudo service avahi-daemon restart
</span></span></code></pre></td></tr></table></div></div></div></article><footer id=footer><div class=footer-left>Copyright &copy; 2024 Hugh(Hui) Liu</div><script src=https://code.iconify.design/2/2.0.4/iconify.min.js></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "7f02cdd7074d4e1f8125c11651f47699"}'></script></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>