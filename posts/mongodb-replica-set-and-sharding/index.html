<!doctype html><html lang=en><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Deploy MongoDB replica set and sharding | RanKKI's Blog</title>
<link rel=canonical href=https://rankki.xyz/posts/mongodb-replica-set-and-sharding/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://rankki.xyz/posts/mongodb-replica-set-and-sharding/"><meta property="og:site_name" content="RanKKI's Blog"><meta property="og:title" content="Deploy MongoDB replica set and sharding"><meta property="og:description" content="Scale-up or Scale-out Why scale? Imagine you have a computer (server) that can serve 5 users at the same time, When Alice becomes the 6th user, Alice has to wait for someone to free up the server resources.
It’s not user friendly, so you need to improve the performance of the server.
Scale-up You decide to upgrade the hardware, using Intel i9 instead of i3, upgrading RAM from 4GB to 64GB and using 1Gbps fibre broadband instead of your ADSL broadband."><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-03T11:33:25+08:00"><meta property="article:modified_time" content="2023-02-12T13:59:15+08:00"><meta property="article:tag" content="Mongodb"><meta name=twitter:card content="summary"><meta name=twitter:title content="Deploy MongoDB replica set and sharding"><meta name=twitter:description content="Scale-up or Scale-out Why scale? Imagine you have a computer (server) that can serve 5 users at the same time, When Alice becomes the 6th user, Alice has to wait for someone to free up the server resources.
It’s not user friendly, so you need to improve the performance of the server.
Scale-up You decide to upgrade the hardware, using Intel i9 instead of i3, upgrading RAM from 4GB to 64GB and using 1Gbps fibre broadband instead of your ADSL broadband."><link rel=stylesheet href=https://rankki.xyz/css/styles.703587cbc83e3d6c4abb083f3126cd73c5c67af0782c70bbc9e4643c1d171ec879a51fed1fd12cf82e0469fc4c2454f83d63696957494d2268aa2cc691a4ef06.css><link rel=stylesheet href=https://rankki.xyz/css/syntax.css><link rel=stylesheet href=https://rankki.xyz/css/loading.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://rankki.xyz/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://rankki.xyz/><div id=title><h1>RanKKI's Blog</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/>Home</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></div></header><div id=header-post><span id=menu><div id=toc><nav id=TableOfContents><ul><li><a href=#scale-up-or-scale-out>Scale-up or Scale-out</a><ul><li><a href=#why-scale>Why scale?</a></li><li><a href=#scale-up>Scale-up</a></li><li><a href=#scale-out>Scale-out</a></li></ul></li><li><a href=#availability>Availability</a></li><li><a href=#deploy-mongodb>Deploy MongoDB</a><ul><li><a href=#standalone-instance>Standalone instance</a></li><li><a href=#replica-set>Replica Set</a></li><li><a href=#sharding>Sharding</a></li></ul></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Deploy MongoDB replica set and sharding</h1><div class=meta><div class=postdate><time datetime="2021-12-03 11:33:25 +0800 CST" itemprop=datePublished>2021-12-03</time>
(Updated: <time datetime="2023-02-12 13:59:15 +0800 CST" itemprop=dateModified>2023-02-12</time>)</div><div class=article-read-time><i class="far fa-clock"></i>
3 minute read</div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/mongodb rel=tag>mongodb</a></div></div></header><div class=content itemprop=articleBody><h2 id=scale-up-or-scale-out>Scale-up or Scale-out</h2><h3 id=why-scale>Why scale?</h3><p>Imagine you have a computer (server) that can serve 5 users at the same time,
When Alice becomes the 6th user, Alice has to wait for someone to free up the server resources.</p><p>It&rsquo;s not user friendly, so you need to improve the performance of the server.</p><h3 id=scale-up>Scale-up</h3><p>You decide to upgrade the hardware, using Intel i9 instead of i3, upgrading RAM from 4GB to 64GB and using 1Gbps fibre broadband instead of your ADSL broadband.</p><p>Now you can serve 10,000 users at the same time, but when Alice becomes the 10001st user and you can&rsquo;t upgrade your server anymore, then you can scale-out your services.</p><h3 id=scale-out>Scale-out</h3><p>If one server can serve 10k users, what if there are 10 servers which can serve 10k * 10 users at the same time.</p><p>Once there are multiple servers serving the same thing, load balancing needs to be considered, as we need a service to route requests to different servers.</p><blockquote><p>In computing, load balancing refers to the process of distributing
a set of tasks across a set of resources (computing units) in order to
of making their overall processing more efficient.</p></blockquote><h2 id=availability>Availability</h2><p>As a service (content) provider, I want my website (in other words, the server) to be online and provide content 7/24, and that is high availability.</p><p>In the case of the database, if one instance goes down, all read/write operations are redirected to another instance.</p><h2 id=deploy-mongodb>Deploy MongoDB</h2><h3 id=standalone-instance>Standalone instance</h3><p>Installing MongoDB is easy, follow the official MongoDB manual from [here] (<a href=https://docs.mongodb.com/manual/installation/>https://docs.mongodb.com/manual/installation/</a>)</p><p>After installation, run these commands to start the MongoDB service</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mkdir -p /srv/mongodb/db
</span></span><span class=line><span class=cl>sudo mongod --port <span class=m>27017</span> --bind_ip localhost,0.0.0.0 --dbpath /srv/mongodb/db --oplogSize <span class=m>128</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=replica-set>Replica Set</h3><blockquote><p>A replica set in MongoDB is a group of mongod processes that maintain the same
the same dataset. Replica Sets Provide Redundancy and High Availability</p></blockquote><p>In a replica set, there is one primary instance, and all other instances are secondary.
All secondary instances are not writable by the client.
Transactions from the client to the primary instance are automatically synchronised to all secondary instances.</p><blockquote><p>A secondary can become a primary. If the current Primary becomes unavailable,
The replica set holds an election to choose which of the secondaries will become the new primary.</p></blockquote><p><img src=https://docs.mongodb.com/manual/images/replica-set-read-write-operations-primary.bakedsvg.svg alt></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mkdir -p /srv/mongodb/rs0-0 /srv/mongodb/rs0-1 /srv/mongodb/rs0-2
</span></span><span class=line><span class=cl>sudo mongod --replSet rs0 --port <span class=m>27017</span> --bind_ip localhost --dbpath /srv/mongodb/rs0-0 --oplogSize <span class=m>128</span>
</span></span><span class=line><span class=cl>sudo mongod --replSet rs0 --port <span class=m>27018</span> --bind_ip localhost --dbpath /srv/mongodb/rs0-1 --oplogSize <span class=m>128</span>
</span></span><span class=line><span class=cl>sudo mongod --replSet rs0 --port <span class=m>27019</span> --bind_ip localhost --dbpath /srv/mongodb/rs0-2 --oplogSize <span class=m>128</span>
</span></span></code></pre></td></tr></table></div></div><p>Running the commands above will create three MongoDB instances and use ports 27017, 27018, 27019 respectively. and these three instances will be assigned to a replica set <code>rs0</code> (you can set the name to anything you want).</p><p>If you want to run these instances on the same machine for testing purposes, you need to add <code>--fork</code> to each command, or open three sessions and run the commands separately.</p><p>Use <code>mongsh</code> to connect one of the instances (i.e. 27017) and run the command to add the rest of the instances to the replica set.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rs.initiate<span class=o>()</span>
</span></span><span class=line><span class=cl>$ rs.add<span class=o>(</span><span class=s2>&#34;ip:27018&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>$ rs.add<span class=o>(</span><span class=s2>&#34;ip:27019&#34;</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Now, whatever you add, update or delete in the primary instance (:27017), it has also been done in the other two instances.</p><h3 id=sharding>Sharding</h3><p>Because <em>Replica Set</em> is used to provide high availability to reduce downtime.
Sharding is solving too many requests to a database instance at the same time. <em><strong>Limitation of the I/O speed</strong></em></p><blockquote><p>Sharding is a method of distributing data across multiple machines.
MongoDB uses sharding to support deployments with very large > data sets and high throughput operations.
and high throughput operations.</p></blockquote><p><img src=https://docs.mongodb.com/manual/images/sharded-cluster-production-architecture.bakedsvg.svg alt></p><p>Starting a config server is similar to a replica set, but with `&ndash;configsvr&rsquo;, (config server must be a replica set)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mongod --configsvr --replSet conf --port <span class=m>27020</span> --bind_ip localhost --dbpath /srv/mongodb/conf-0 --oplogSize <span class=m>128</span>
</span></span></code></pre></td></tr></table></div></div><p>The replica set used in sharding must be run with `&ndash;shardsvr'.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mongod -shardsvr --replSet rs0 --port <span class=m>27017</span> --bind_ip localhost --dbpath /srv/mongodb/rs0-0 --oplogSize <span class=m>128</span>
</span></span></code></pre></td></tr></table></div></div><p>After starting the config server, add 2 or more replica sets to the config server.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mongosh ip:27020
</span></span><span class=line><span class=cl>sh.addShard<span class=o>(</span> <span class=s2>&#34;rs0/ip:27017,ip:27018,ip:27019&#34;</span> <span class=o>)</span>
</span></span><span class=line><span class=cl>sh.addShard<span class=o>(</span> <span class=s2>&#34;rs1/ip:27017,ip:27018,ip:27019&#34;</span> <span class=o>)</span>
</span></span><span class=line><span class=cl>sh.addShard<span class=o>(</span> <span class=s2>&#34;rs2/ip:27017,ip:27018,ip:27019&#34;</span> <span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>And then use <code>enableSharding</code> to determine which database to shard, then specify which key of the collection to use as the <em>shard key</em>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sh.enableSharding<span class=o>(</span><span class=s2>&#34;test&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>sh.shardCollection<span class=o>(</span><span class=s2>&#34;database.collection&#34;</span>, <span class=o>{</span> uid : <span class=s2>&#34;hashed&#34;</span> <span class=o>}</span> <span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Now connect to the config server as if you were connecting to a single MongoDB instance, Each document will be inserted into a different replica set based on the hashed shared key <code>uid</code>.</p><hr><ul><li><a href=https://en.wikipedia.org/wiki/Load_balancing_(computing)>https://en.wikipedia.org/wiki/Load_balancing_(computing)</a></li><li><a href=https://docs.mongodb.com/manual>https://docs.mongodb.com/manual</a></li></ul></div></article><footer id=footer><div class=footer-left>Copyright &copy; 2024 Hugh(Hui) Liu</div><script src=https://code.iconify.design/2/2.0.4/iconify.min.js></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "7f02cdd7074d4e1f8125c11651f47699"}'></script></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>