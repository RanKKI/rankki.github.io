<!doctype html><html lang=en><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Zero-downtime upgrade by using Docker Swarm | RanKKI's Blog</title>
<link rel=canonical href=https://rankki.xyz/posts/zero-downtime-upgrade-by-using-docker-swarm/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://rankki.xyz/posts/zero-downtime-upgrade-by-using-docker-swarm/"><meta property="og:site_name" content="RanKKI's Blog"><meta property="og:title" content="Zero-downtime upgrade by using Docker Swarm"><meta property="og:description" content="We want users to be able to continue using the service during the upgrade process, the first thing we have to do is kill the process when we want to upgrade a running application, and then restart it.
Here is the problem, there is a gap between killing and restarting a process, is there a way to solve this?
And what if the new changes have bugs? How do we restart the old application in a quick way?"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-11T13:52:28+08:00"><meta property="article:modified_time" content="2023-02-17T15:23:34+08:00"><meta property="article:tag" content="Docker"><meta name=twitter:card content="summary"><meta name=twitter:title content="Zero-downtime upgrade by using Docker Swarm"><meta name=twitter:description content="We want users to be able to continue using the service during the upgrade process, the first thing we have to do is kill the process when we want to upgrade a running application, and then restart it.
Here is the problem, there is a gap between killing and restarting a process, is there a way to solve this?
And what if the new changes have bugs? How do we restart the old application in a quick way?"><link rel=stylesheet href=https://rankki.xyz/css/styles.703587cbc83e3d6c4abb083f3126cd73c5c67af0782c70bbc9e4643c1d171ec879a51fed1fd12cf82e0469fc4c2454f83d63696957494d2268aa2cc691a4ef06.css><link rel=stylesheet href=https://rankki.xyz/css/syntax.css><link rel=stylesheet href=https://rankki.xyz/css/loading.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://rankki.xyz/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://rankki.xyz/><div id=title><h1>RanKKI's Blog</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/>Home</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></div></header><div id=header-post><span id=menu><div id=toc><nav id=TableOfContents><ul><li><a href=#concepts>Concepts</a><ul><li><a href=#rolling-update>Rolling update</a></li><li><a href=#load-balancing>Load balancing</a></li><li><a href=#rollback>Rollback</a></li></ul></li><li><a href=#docker-swarm>Docker Swarm</a><ul><li><a href=#init-swarm>Init Swarm</a></li><li><a href=#join-swarm>Join Swarm</a></li></ul></li><li><a href=#docker-service>Docker Service</a><ul><li><a href=#create>Create</a></li><li><a href=#update>Update</a></li><li><a href=#zero-downtime-update>Zero-Downtime Update</a></li><li><a href=#scale>Scale</a></li></ul></li></ul></nav></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Zero-downtime upgrade by using Docker Swarm</h1><div class=meta><div class=postdate><time datetime="2023-02-11 13:52:28 +0800 CST" itemprop=datePublished>2023-02-11</time>
(Updated: <time datetime="2023-02-17 15:23:34 +0800 CST" itemprop=dateModified>2023-02-17</time>)</div><div class=article-read-time><i class="far fa-clock"></i>
2 minute read</div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/docker rel=tag>Docker</a></div></div></header><div class=content itemprop=articleBody><p>We want users to be able to continue using the service during the upgrade process, the first thing we have to do is kill the process when we want to upgrade a running application, and then restart it.</p><p>Here is the problem, there is a gap between killing and restarting a process, is there a way to solve this?</p><p>And what if the new changes have bugs? How do we restart the old application in a quick way?</p><h2 id=concepts>Concepts</h2><h3 id=rolling-update>Rolling update</h3><p>The technical name of this is <strong>Rolling Update</strong>, we can continuously deliver our new changes without any downtime.</p><p>The concept is simple, stop the old process after the new process is started and then move all the traffic from the old process to the new one.</p><h3 id=load-balancing>Load balancing</h3><p>To do this, we may need a service call <strong>Load Balance</strong>, it will navigate all requests to different nodes.</p><p>By decreasing the workload weight of the outdated process, no new requests will be directed towards it. This will allow us to safely shut down the old node.</p><h3 id=rollback>Rollback</h3><p>We can <strong>Rollback</strong> the service if there&rsquo;s a bug in the new node by replacing the current application with its previous version.</p><p>But, manually performing the task and keeping track of previous releases is challenging.</p><h2 id=docker-swarm>Docker Swarm</h2><blockquote><p>Swarm provides many tools for scaling, networking, securing and maintaining your containerized applications, above and beyond the abilities of containers themselves.</p></blockquote><h3 id=init-swarm>Init Swarm</h3><pre tabindex=0><code>docker swarm init
</code></pre><p>By using this command, we had initiated the swarm environment and treat current machine as a Leader</p><h3 id=join-swarm>Join Swarm</h3><p>On other machines, we can use command to join a swarm as a worker node</p><pre tabindex=0><code>docker swarm join --token &lt;TOKEN&gt; &lt;IP&gt;:&lt;PORT&gt;
</code></pre><h2 id=docker-service>Docker Service</h2><p>Docker service works with the Swarm orchestrator.</p><h3 id=create>Create</h3><pre tabindex=0><code>docker service create [OPTIONS] IMAGE [COMMAND] [ARG...]
</code></pre><h3 id=update>Update</h3><pre tabindex=0><code>docker service update [OPTIONS] SERVICE
</code></pre><h3 id=zero-downtime-update>Zero-Downtime Update</h3><p>by default, updating a service will stop current node first, then run the latest image, by adding <code>--update-order start-first</code>, we can start the new image first, then stop the old node.</p><pre tabindex=0><code>docker service update --update-order start-first [OPTIONS]  SERVICE
</code></pre><h3 id=scale>Scale</h3><p>if the resources usage are too high of a single node, we can scale-out this service, let other nodes run the same service to balance the workloads</p><pre tabindex=0><code>docker service scale SERVICE=&lt;NUMBER&gt;
</code></pre><p>But remember, you need more than one node in your Swarm orchestrator, otherwise these services will still run on a single machine.</p></div></article><footer id=footer><div class=footer-left>Copyright &copy; 2024 Hugh(Hui) Liu</div><script src=https://code.iconify.design/2/2.0.4/iconify.min.js></script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "7f02cdd7074d4e1f8125c11651f47699"}'></script></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>